# Реализация Сервиса Статистики

## Обзор

Реализован централизованный сервис статистики `IStatisticsService` для загрузки реальных данных в главном окне приложения ViridiscaUi.

## Реализованные компоненты

### 1. Интерфейс сервиса статистики
**Файл:** `ViridiscaUi/Services/Interfaces/IStatisticsService.cs`

Определяет контракт для получения различных типов статистики:
- `GetSystemStatisticsAsync()` - общая статистика системы
- `GetUserStatisticsAsync(Guid userUid)` - статистика конкретного пользователя
- `GetActivityStatisticsAsync()` - статистика активности

### 2. Реализация сервиса статистики
**Файл:** `ViridiscaUi/Services/Implementations/StatisticsService.cs`

Реализует интерфейс `IStatisticsService` и собирает данные из различных сервисов:
- **Студенты:** `IStudentService.GetAllStudentsAsync()` и `GetStudentsByStatusAsync(StudentStatus.Active)`
- **Преподаватели:** `ITeacherService.GetAllTeachersAsync()`
- **Курсы:** `ICourseService.GetAllCoursesAsync()` с фильтрацией по статусу
- **Задания:** `IAssignmentService.GetAllAssignmentsAsync()`
- **Группы:** `IGroupService.GetAllAsync()`
- **Предметы:** `ISubjectService.GetAllSubjectsAsync()`
- **Департаменты:** `IDepartmentService.GetAllDepartmentsAsync()`
- **Уведомления:** `INotificationService.GetUnreadCountAsync()`

### 3. Модели данных статистики

#### SystemStatistics
- `TotalStudents` - общее количество студентов
- `TotalTeachers` - общее количество преподавателей
- `TotalCourses` - общее количество курсов
- `TotalAssignments` - общее количество заданий
- `ActiveCourses` - количество активных курсов
- `ActiveStudents` - количество активных студентов
- `TotalGroups` - количество групп
- `TotalSubjects` - количество предметов
- `TotalDepartments` - количество департаментов
- `LastUpdated` - дата последнего обновления

#### UserStatistics
- `UnreadNotifications` - количество непрочитанных уведомлений
- `ActiveAssignments` - количество активных заданий
- `OverdueAssignments` - количество просроченных заданий
- `TotalCourses` - количество курсов пользователя
- `AverageGrade` - средняя оценка

#### ActivityStatistics
- `OnlineUsersCount` - количество пользователей онлайн
- `ActiveSessions` - количество активных сессий
- `TodayActions` - количество действий за сегодня
- `WeekActions` - количество действий за неделю
- `PeakActivityTime` - пиковое время активности

### 4. Обновление MainViewModel
**Файл:** `ViridiscaUi/ViewModels/MainViewModel.cs`

Изменения:
- Добавлена инъекция зависимости `IStatisticsService`
- Добавлено свойство `IsLoadingStatistics` для индикации загрузки
- Добавлена команда `RefreshStatisticsCommand` для обновления статистики
- Метод `LoadStatisticsAsync()` теперь использует реальные данные из сервисов
- Добавлено логирование и обработка ошибок

### 5. Регистрация в DI контейнере
**Файл:** `ViridiscaUi/DI/DependencyInjectionExtensions.cs`

Добавлена регистрация сервиса:
```csharp
services.AddScoped<IStatisticsService, StatisticsService>();
```

## Особенности реализации

### Параллельная загрузка данных
Для оптимизации производительности все запросы к сервисам выполняются параллельно с использованием `Task.WhenAll()`.

### Обработка ошибок
- Каждый запрос к сервису обернут в try-catch блок
- В случае ошибки отдельного сервиса возвращается значение по умолчанию (0)
- Общие ошибки логируются и отображаются пользователю

### Логирование
Добавлено подробное логирование:
- Начало и завершение загрузки статистики
- Успешная загрузка с указанием количества записей
- Предупреждения при ошибках отдельных сервисов
- Ошибки при общих сбоях

### Заглушки для будущих функций
Некоторые метрики (онлайн пользователи, активные сессии) пока используют заглушки с комментариями TODO для будущей реализации.

## Использование

После запуска приложения статистика автоматически загружается при инициализации `MainViewModel`. Пользователь может обновить статистику с помощью команды `RefreshStatisticsCommand`.

Статистика отображается в главном окне приложения и обновляется в реальном времени на основе данных из базы данных.

## Тестирование

Для тестирования реализации:
1. Запустите приложение
2. Проверьте, что статистика загружается при старте
3. Используйте команду обновления статистики
4. Проверьте логи для подтверждения корректной работы сервисов

## Дальнейшие улучшения

1. Реализация кэширования статистики
2. Добавление реального подсчета онлайн пользователей
3. Реализация статистики активности на основе логов действий пользователей
4. Добавление unit-тестов для сервиса статистики
5. Оптимизация запросов к базе данных для больших объемов данных 